name: Check Links

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight
  push:
    branches: [ main ]  # Run on pushes to main
  pull_request:
    branches: [ main ]  # Run on PRs to main
  workflow_dispatch:    # Allow manual triggers

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        
      - name: Start development server
        run: |
          npm run build
          npm run preview &
          sleep 10  # Wait for server to start
        
      - name: Check links
        run: npm run check-links
        
      - name: Upload report
        if: always()  # Upload report even if check fails
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report-${{ github.sha }}
          path: reports/
          retention-days: 30
          
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get the most recent report
            const reportsDir = path.join(process.env.GITHUB_WORKSPACE, 'reports');
            const files = fs.readdirSync(reportsDir);
            const latestReport = files.sort().pop();
            const report = fs.readFileSync(path.join(reportsDir, latestReport), 'utf8');
            
            // Create comment
            const body = `### ⚠️ Broken Links Detected
            
            ${report}
            
            Please fix these broken links before merging.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            }); 